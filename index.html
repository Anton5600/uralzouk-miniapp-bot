<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–®–∫–æ–ª–∞ —Ç–∞–Ω—Ü–µ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
    }

    header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .card {
      background: var(--tg-theme-secondary-bg-color, #f5f5f5);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .card h2 {
      font-size: 20px;
      margin-bottom: 15px;
    }

    .balance {
      font-size: 48px;
      font-weight: bold;
      color: var(--tg-theme-button-color, #3390ec);
      text-align: center;
      margin: 20px 0;
    }

    .payment-amount {
      font-size: 32px;
      font-weight: bold;
      text-align: center;
      margin: 10px 0;
    }

    .payment-date {
      text-align: center;
      color: #666;
      font-size: 14px;
    }

    .schedule-item {
      padding: 12px 0;
      border-bottom: 1px solid #ddd;
    }

    .schedule-item:last-child {
      border-bottom: none;
    }

    .schedule-item strong {
      display: block;
      margin-bottom: 5px;
    }

    .student-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid #ddd;
    }

    .student-item:last-child {
      border-bottom: none;
    }

    .student-info strong {
      display: block;
      margin-bottom: 5px;
      font-size: 16px;
    }

    .student-info p {
      font-size: 13px;
      color: #666;
      margin: 3px 0;
    }

    .btn {
      background: var(--tg-theme-button-color, #3390ec);
      color: var(--tg-theme-button-text-color, #ffffff);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }

    .btn:active {
      opacity: 0.7;
    }

    .btn-success {
      background: #28a745;
      color: white;
      margin-left: 10px;
    }

    .loading {
      text-align: center;
      padding: 50px 20px;
      font-size: 18px;
    }

    .error {
      text-align: center;
      padding: 50px 20px;
      color: #e74c3c;
    }

    .hidden {
      display: none;
    }

    .add-form {
      margin-top: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab {
      flex: 1;
      padding: 12px;
      background: #e0e0e0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }

    .tab.active {
      background: var(--tg-theme-button-color, #3390ec);
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="error" class="error hidden"></div>
    <div id="content" class="hidden">
      <header>
        <h1>üï∫ –®–∫–æ–ª–∞ —Ç–∞–Ω—Ü–µ–≤</h1>
        <p id="greeting"></p>
      </header>

      <!-- –†–∞–∑–¥–µ–ª –¥–ª—è —É—á–µ–Ω–∏–∫–∞ -->
      <div id="studentSection" class="hidden">
        <div class="card">
          <h2>üí≥ –í–∞—à –±–∞–ª–∞–Ω—Å</h2>
          <div class="balance" id="balance">0</div>
        </div>

        <div class="card">
          <h2>üí∞ –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂</h2>
          <p class="payment-amount" id="lastPayment">0 ‚ÇΩ</p>
          <p class="payment-date" id="paymentDate">-</p>
        </div>

        <div class="card">
          <h2>üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h2>
          <div id="schedule"></div>
        </div>

        <div class="card">
          <h2>üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
          <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> +7 (XXX) XXX-XX-XX</p>
          <p><strong>Email:</strong> info@danceschool.ru</p>
          <p><strong>–ê–¥—Ä–µ—Å:</strong> –≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 123</p>
        </div>
      </div>

      <!-- –†–∞–∑–¥–µ–ª –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
      <div id="adminSection" class="hidden">
        <div class="tabs">
          <button class="tab active" onclick="showTab('students')">–£—á–µ–Ω–∏–∫–∏</button>
          <button class="tab" onclick="showTab('add')">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="tab" onclick="showTab('payment')">–ü–ª–∞—Ç–µ–∂</button>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º —É—á–µ–Ω–∏–∫–æ–≤ -->
        <div id="studentsTab" class="card">
          <h2>üë• –°–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤</h2>
          <div id="studentsList"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞ -->
        <div id="addTab" class="card hidden">
          <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</h2>
          <div class="add-form">
            <div class="form-group">
              <label>–ò–º—è:</label>
              <input type="text" id="newName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
            </div>
            <div class="form-group">
              <label>Telegram ID:</label>
              <input type="text" id="newTelegramId" placeholder="–í–≤–µ–¥–∏—Ç–µ Telegram ID">
            </div>
            <div class="form-group">
              <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–Ω—è—Ç–∏–π:</label>
              <input type="number" id="newBalance" placeholder="8" value="8">
            </div>
            <div class="form-group">
              <label>–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞:</label>
              <input type="number" id="newPayment" placeholder="3200" value="3200">
            </div>
            <button class="btn" onclick="addNewStudent()">–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</button>
          </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ -->
        <div id="paymentTab" class="card hidden">
          <h2>üí∞ –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂</h2>
          <div class="add-form">
            <div class="form-group">
              <label>–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞:</label>
              <select id="paymentStudent" style="width: 100%; padding: 10px; border-radius: 6px;">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
              </select>
            </div>
            <div class="form-group">
              <label>–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞:</label>
              <input type="number" id="paymentAmount" placeholder="3200" value="3200">
            </div>
            <div class="form-group">
              <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–Ω—è—Ç–∏–π:</label>
              <input type="number" id="paymentLessons" placeholder="8" value="8">
            </div>
            <button class="btn" onclick="addPaymentToStudent()">–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–æ—Ç URL –Ω–∞ URL –≤–∞—à–µ–≥–æ Google Apps Script
    const API_URL = 'https://script.google.com/macros/s/AKfycbxJjLRl-PCXYCMu8QMfGWpm6FIK92qJrJhvbaZyYMakHnzjnjnUa6fZEclDYfn_eTi5rg/exec';
    
    let tg = window.Telegram.WebApp;
    let user = null;
    let studentData = null;
    let allStudents = [];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    tg.ready();
    tg.expand();

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        user = tg.initDataUnsafe.user;
        if (!user) {
          showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram');
          return;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞
        const response = await fetch(`${API_URL}?action=getStudent&telegramId=${user.id}`);
        const data = await response.json();

        if (data.error) {
          showError('–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —à–∫–æ–ª—ã —Ç–∞–Ω—Ü–µ–≤.');
          return;
        }

        studentData = data;
        document.getElementById('greeting').textContent = `–ü—Ä–∏–≤–µ—Ç, ${data.name}!`;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (data.role === '–ê–¥–º–∏–Ω') {
          await loadAdminData();
        } else {
          await loadStudentData();
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —É—á–µ–Ω–∏–∫–∞
    async function loadStudentData() {
      document.getElementById('studentSection').classList.remove('hidden');
      document.getElementById('balance').textContent = `${studentData.balance} –∑–∞–Ω—è—Ç–∏–π`;
      document.getElementById('lastPayment').textContent = `${studentData.lastPayment} ‚ÇΩ`;
      document.getElementById('paymentDate').textContent = `–î–∞—Ç–∞: ${studentData.paymentDate}`;

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
      const scheduleResponse = await fetch(`${API_URL}?action=getSchedule`);
      const scheduleData = await scheduleResponse.json();
      
      const scheduleHtml = scheduleData.schedule.map(item => `
        <div class="schedule-item">
          <strong>${item.day}</strong>
          <p>${item.time} - ${item.level}</p>
        </div>
      `).join('');
      
      document.getElementById('schedule').innerHTML = scheduleHtml;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    async function loadAdminData() {
      document.getElementById('adminSection').classList.remove('hidden');
      
      const response = await fetch(`${API_URL}?action=getStudents&adminId=${user.id}`);
      const data = await response.json();
      
      if (data.error) {
        showError(data.error);
        return;
      }

      allStudents = data.students;
      renderStudentsList();
      updatePaymentSelect();
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —É—á–µ–Ω–∏–∫–æ–≤
    function renderStudentsList() {
      const html = allStudents.map(student => `
        <div class="student-item">
          <div class="student-info">
            <strong>${student.name}</strong>
            <p>–ë–∞–ª–∞–Ω—Å: ${student.balance} –∑–∞–Ω—è—Ç–∏–π</p>
            <p>–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂: ${student.lastPayment} ‚ÇΩ (${student.paymentDate})</p>
          </div>
          ${student.role !== '–ê–¥–º–∏–Ω' ? `
            <button class="btn" onclick="markAttendance('${student.telegramId}', '${student.name}')">
              ‚úì –û—Ç–º–µ—Ç–∏—Ç—å
            </button>
          ` : ''}
        </div>
      `).join('');
      
      document.getElementById('studentsList').innerHTML = html;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞
    function updatePaymentSelect() {
      const select = document.getElementById('paymentStudent');
      const options = allStudents
        .filter(s => s.role !== '–ê–¥–º–∏–Ω')
        .map(s => `<option value="${s.telegramId}">${s.name}</option>`)
        .join('');
      select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>' + options;
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    function showTab(tabName) {
      // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      
      // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
      document.getElementById('studentsTab').classList.add('hidden');
      document.getElementById('addTab').classList.add('hidden');
      document.getElementById('paymentTab').classList.add('hidden');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É
      if (tabName === 'students') {
        document.getElementById('studentsTab').classList.remove('hidden');
        document.querySelectorAll('.tab')[0].classList.add('active');
      } else if (tabName === 'add') {
        document.getElementById('addTab').classList.remove('hidden');
        document.querySelectorAll('.tab')[1].classList.add('active');
      } else if (tabName === 'payment') {
        document.getElementById('paymentTab').classList.remove('hidden');
        document.querySelectorAll('.tab')[2].classList.add('active');
      }
    }

    // –û—Ç–º–µ—Ç–∏—Ç—å –ø–æ—Å–µ—â–µ–Ω–∏–µ
    async function markAttendance(telegramId, name) {
      try {
        const response = await fetch(`${API_URL}?action=markAttendance`, {
          method: 'POST',
          body: JSON.stringify({
            telegramId: telegramId,
            adminId: user.id.toString()
          })
        });

        const data = await response.json();
        
        if (data.error) {
          tg.showAlert(data.error);
          return;
        }

        tg.showAlert(`–ü–æ—Å–µ—â–µ–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ –¥–ª—è ${name}!`);
        await loadAdminData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø–æ—Å–µ—â–µ–Ω–∏—è');
      }
    }

    // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞
    async function addNewStudent() {
      const name = document.getElementById('newName').value.trim();
      const telegramId = document.getElementById('newTelegramId').value.trim();
      const balance = document.getElementById('newBalance').value;
      const payment = document.getElementById('newPayment').value;

      if (!name || !telegramId) {
        tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
      }

      try {
        const response = await fetch(`${API_URL}?action=addStudent`, {
          method: 'POST',
          body: JSON.stringify({
            name: name,
            telegramId: telegramId,
            balance: balance,
            payment: payment,
            date: new Date().toLocaleDateString('ru-RU'),
            adminId: user.id.toString()
          })
        });

        const data = await response.json();
        
        if (data.error) {
          tg.showAlert(data.error);
          return;
        }

        tg.showAlert('–£—á–µ–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
        
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('newName').value = '';
        document.getElementById('newTelegramId').value = '';
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É
        await loadAdminData();
        showTab('students');
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–µ–Ω–∏–∫–∞');
      }
    }

    // –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂
    async function addPaymentToStudent() {
      const telegramId = document.getElementById('paymentStudent').value;
      const amount = document.getElementById('paymentAmount').value;
      const lessons = document.getElementById('paymentLessons').value;

      if (!telegram
